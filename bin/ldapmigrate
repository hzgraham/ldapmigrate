#!/usr/bin/env python

import argparse
import getpass
from ldapmigrate.ldapMigrateUsers import ldapMigrateUsers
from ldapmigrate.PromptAction import PromptAction
#LDAP_HOST = 'ldap://ldap.example.com'
#LDAP_BASE_DN = 'dc=example,dc=com'

if __name__ == "__main__":

    login = getpass.getuser()
    #argparse docs
    #https://docs.python.org/3/library/argparse.html#metavar
    #usage = "Usage: %prog [options] <uid>"
    parser = argparse.ArgumentParser(description='Migrate users and groups between envs.')

    parser.add_argument('entry',
                        # required=True,
                        # action="store_true",
                        metavar="Entry",
                        help='the entry being migrated, for example uid=cplanet or "cn=captain planet"')

    # parser.add_argument('-cn', '--name',
    #                     dest='full_name',
    #                     help='search for the user by first and last name in quotes')
    # parser.add_argument('--host',
    #                     required=True,
    #                     dest='host',
    #                     help='enter the LDAP uri for example: ldap.example.com')
    # parser.add_argument('--basedn','-b',
    #                     required=True,
    #                     dest='basedn',
    #                     help='The search base for LDAP for example: dc=example,dc=com')

    # subparsers = parser.add_subparsers(title='Commands',
    #                                    dest='command',
    #                                    help='sub-command help')

    subparsers = parser.add_subparsers(help='sub-command help')
    #Refresh subparser for migrating entries to lower environments such as Dev
    parser_refresh = subparsers.add_parser('refresh',
                                           help='Migrating users to lower environments')
    parser_refresh.add_argument('-cn', '--name',
                                dest='full_name',
                                help='search for the user by first and last name in quotes')
    parser_refresh.add_argument('-m','--topmaster',
                                required=True,
                                dest='host',
                                help='enter the LDAP Master uri for example: ldapmaster.example.com')
    parser_refresh.add_argument('-l','--lowermaster',
                                required=True,
                                dest='mod_host',
                                help='enter the LDAP uri of the lower level LDAP Master, example: ldap.example.com')
    parser_refresh.add_argument('--basedn','-b',
                                required=True,
                                dest='basedn',
                                help='The search base for LDAP for example: dc=example,dc=com')
    parser_refresh.add_argument('--password', metavar='password', \
                                    dest='password', \
                                    nargs='*', \
                                    required=True, \
                                    action=PromptAction, \
                                    help='Plain text password for user')
    
    #Promote subparser for promoting entries up through environments towards Prod
    parser_promote = subparsers.add_parser('promote',
                                           help='Move entries from lower env up towards Prod')
    parser_promote.add_argument('-cn', '--name',
                                dest='full_name',
                                help='search for the user by first and last name in quotes')
    parser_promote.add_argument('-e', '--env',
                                required=True,
                                help="The environment to promote to")
    parser_promote.add_argument('-m','--topmaster',
                                required=True,
                                dest='host',
                                help='enter the LDAP Master uri for example: ldapmaster.example.com')
    parser_promote.add_argument('-l','--lowermaster',
                                required=True,
                                dest='mod_host',
                                help='enter the LDAP uri of the lower level LDAP Master, example: ldap.example.com')
    parser_promote.add_argument('--basedn','-b',
                                required=True,
                                dest='basedn',
                                help='The search base for LDAP for example: dc=example,dc=com')
    parser_refresh.add_argument('--password', metavar='password', \
                                    dest='password', \
                                    nargs='*', \
                                    required=True, \
                                    action=PromptAction, \
                                    help='Plain text password for user')

    args = parser.parse_args()
    print args
    LDAP_HOST = args.host
    LDAP_MOD_HOST = args.mod_host
    LDAP_BASE_DN = args.basedn
    search_entry  = args.entry

    print LDAP_HOST
    print LDAP_BASE_DN
    if not args:
        parser.print_help()
        sys.exit(1)

    user_name = None
    pw = None
    
    user_migrate = ldapMigrateUsers(login=login, ldap_host=LDAP_HOST, ldap_mod_host=LDAP_MOD_HOST, ldap_base_dn=LDAP_BASE_DN)
    print search_entry
    if search_entry:
        user_migrate.migrate_user(search_entry)

#print "Doing unbind"
#l.unbind()
